import fixturesJson from "@/lib/courses/solana-security/project/scenarios/fixtures.v1.json";
import ownerMissingJson from "@/lib/courses/solana-security/project/scenarios/owner-missing.json";
import pdaSpoofJson from "@/lib/courses/solana-security/project/scenarios/pda-spoof.json";
import signerMissingJson from "@/lib/courses/solana-security/project/scenarios/signer-missing.json";
import { deriveVaultPda } from "@/lib/courses/solana-security/project/model/pda";
import type { LabAccount, ProgramInstruction, RuntimeSnapshot, ScenarioSpec } from "@/lib/courses/solana-security/project/types";

interface Fixtures {
  programId: string;
  authority: string;
  attacker: string;
  recipient: string;
  vaultBump: number;
  initialVaultBalance: string;
  initialRecipientLamports: string;
}

const fixtures = fixturesJson as Fixtures;
const signerMissing = signerMissingJson as ScenarioSpec;
const ownerMissing = ownerMissingJson as ScenarioSpec;
const pdaSpoof = pdaSpoofJson as ScenarioSpec;

export const securityScenarios: readonly ScenarioSpec[] = [signerMissing, ownerMissing, pdaSpoof];

export function createBaseSnapshot(scenario: ScenarioSpec): RuntimeSnapshot {
  const vaultPda = deriveVaultPda(fixtures.authority, fixtures.vaultBump, fixtures.programId).pda;
  const vaultOwner = scenario.useWrongVaultOwner
    ? "AttackerProgram111111111111111111111111111111"
    : fixtures.programId;

  const vaultAccount: LabAccount = {
    pubkey: scenario.useSpoofedPda ? "PDA_spoofed_vault_account_111111111" : vaultPda,
    owner: vaultOwner,
    lamports: fixtures.initialVaultBalance,
    isSigner: false,
    isWritable: true,
    rentExempt: true,
    data: {
      authority: fixtures.authority,
      bump: fixtures.vaultBump,
      balance: fixtures.initialVaultBalance,
    },
  };

  const authorityAccount: LabAccount = {
    pubkey: fixtures.authority,
    owner: "SystemProgram1111111111111111111111111111111111",
    lamports: "100",
    isSigner: scenario.authorityIsSigner,
    isWritable: false,
    rentExempt: true,
  };

  const attackerAccount: LabAccount = {
    pubkey: fixtures.attacker,
    owner: "SystemProgram1111111111111111111111111111111111",
    lamports: "50",
    isSigner: scenario.attackerIsSigner,
    isWritable: false,
    rentExempt: true,
  };

  const recipientAccount: LabAccount = {
    pubkey: fixtures.recipient,
    owner: "SystemProgram1111111111111111111111111111111111",
    lamports: fixtures.initialRecipientLamports,
    isSigner: false,
    isWritable: true,
    rentExempt: true,
  };

  return {
    accounts: {
      [authorityAccount.pubkey]: authorityAccount,
      [attackerAccount.pubkey]: attackerAccount,
      [recipientAccount.pubkey]: recipientAccount,
      [vaultAccount.pubkey]: vaultAccount,
    },
  };
}

export function buildInstructionForScenario(scenario: ScenarioSpec): ProgramInstruction {
  const expectedVaultPda = deriveVaultPda(fixtures.authority, fixtures.vaultBump, fixtures.programId).pda;
  const usedVaultPda = scenario.useSpoofedPda ? "PDA_spoofed_vault_account_111111111" : expectedVaultPda;

  return {
    id: `withdraw-${scenario.id}`,
    programId: fixtures.programId,
    name: "withdraw",
    accounts: {
      authority: fixtures.authority,
      vaultPda: usedVaultPda,
      recipientAccount: fixtures.recipient,
      configAccount: fixtures.attacker,
    },
    args: {
      amount: scenario.amount,
      bump: fixtures.vaultBump,
    },
  };
}

export function getSecurityFixtures(): Fixtures {
  return fixtures;
}
