import { canonicalJson } from "@/lib/courses/solana-security/project/crypto/canonical-json";
import { sha256Hex } from "@/lib/courses/solana-security/project/crypto/sha256";
import { executeInstruction } from "@/lib/courses/solana-security/project/model/runtime";
import { buildInstructionForScenario, createBaseSnapshot, securityScenarios } from "@/lib/courses/solana-security/project/exploit/reproduce";
import type { ExploitProof, RuntimeMode, ScenarioOutcome, ScenarioSpec } from "@/lib/courses/solana-security/project/types";

export function runScenario(mode: RuntimeMode, scenario: ScenarioSpec): ScenarioOutcome {
  const before = createBaseSnapshot(scenario);
  const instruction = buildInstructionForScenario(scenario);
  const vaultPubkey = instruction.accounts.vaultPda;
  const recipient = instruction.accounts.recipientAccount;

  const beforeVaultBalance = before.accounts[vaultPubkey].lamports;
  const beforeRecipientLamports = before.accounts[recipient].lamports;

  const result = executeInstruction(before, instruction, mode);

  const afterVaultBalance = result.snapshot.accounts[vaultPubkey].lamports;
  const afterRecipientLamports = result.snapshot.accounts[recipient].lamports;

  return {
    id: scenario.id,
    mode,
    ok: result.ok,
    code: result.code,
    beforeVaultBalance,
    afterVaultBalance,
    beforeRecipientLamports,
    afterRecipientLamports,
    trace: result.trace,
    snapshot: result.snapshot,
  };
}

export function traceHash(trace: ScenarioOutcome["trace"]): string {
  return sha256Hex(canonicalJson(trace));
}

export function buildExploitProof(scenario: ScenarioSpec): ExploitProof {
  const vulnerable = runScenario("vulnerable", scenario);
  const fixed = runScenario("fixed", scenario);
  const drained = BigInt(vulnerable.afterRecipientLamports) - BigInt(vulnerable.beforeRecipientLamports);

  return {
    scenarioId: scenario.id,
    drainedLamports: drained.toString(),
    vulnerableTraceHash: traceHash(vulnerable.trace),
    fixedTraceHash: traceHash(fixed.trace),
    explanation: `Scenario ${scenario.id} drains ${drained.toString()} lamports in vulnerable mode and is blocked in fixed mode.`,
  };
}

export function runAllScenarios(mode: RuntimeMode): ScenarioOutcome[] {
  return securityScenarios.map((scenario) => runScenario(mode, scenario));
}
