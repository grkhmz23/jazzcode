import { describe, expect, it } from "vitest";
import { compareScenarioModes } from "@/lib/courses/solana-security/project/exploit/diff";
import { buildExploitProof, runScenario, traceHash } from "@/lib/courses/solana-security/project/exploit/run";
import { securityScenarios } from "@/lib/courses/solana-security/project/exploit/reproduce";

function scenario(id: string) {
  const target = securityScenarios.find((item) => item.id === id);
  if (!target) {
    throw new Error(`Scenario not found: ${id}`);
  }
  return target;
}

describe("solana security exploits", () => {
  it("vulnerable scenarios reproduce exploits with deterministic traces", () => {
    for (const id of ["signer-missing", "owner-missing", "pda-spoof"]) {
      const outcome = runScenario("vulnerable", scenario(id));
      expect(outcome.ok).toBe(true);
      expect(traceHash(outcome.trace).length).toBe(64);
    }
  });

  it("builds deterministic exploit proof for signer-missing", () => {
    const proof = buildExploitProof(scenario("signer-missing"));

    expect(proof.scenarioId).toBe("signer-missing");
    expect(proof.drainedLamports).toBe("700");
    expect(proof.vulnerableTraceHash).toBe("1e612fd4a559172c834daee280d2c69ff736ddfef7d9c1fc9e3279a1256743ff");
    expect(proof.fixedTraceHash).toBe("fa7b6a34c8d1b33195a5fe5c80166d208213b0e9cf8f3e551f0736dd4015a85d");
  });

  it("diff shows vulnerable succeeds while fixed blocks", () => {
    const signerDiff = compareScenarioModes(scenario("signer-missing"));
    const ownerDiff = compareScenarioModes(scenario("owner-missing"));
    const pdaDiff = compareScenarioModes(scenario("pda-spoof"));

    expect(signerDiff.vulnerableOk).toBe(true);
    expect(signerDiff.fixedOk).toBe(false);
    expect(signerDiff.fixedCode).toBe("ERR_NOT_SIGNER");

    expect(ownerDiff.fixedCode).toBe("ERR_BAD_OWNER");
    expect(pdaDiff.fixedCode).toBe("ERR_BAD_PDA");
  });
});
